<!doctype html>
<html lang="en-us">
    <head>
        <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta name="generator" content="Hugo 0.16" />
        <title>Tag-based routing in laconi.ca</title>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,300,700' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Bree+Serif' rel='stylesheet' type='text/css'>
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
        <link rel="stylesheet" type="text/css" href="http://flagzeta.org//css/crisp.css">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="keywords" content="code,python,django,it,software architecture,technical architecture">
        <meta name="author" content="Federico Marani">
        
    </head>
    <body>

<header id="header">
    <a id="logo" href="/"><img src="http://flagzeta.org//img/me.png" alt="me" /></a>
    <a href="http://flagzeta.org/"><h1>Blog | Federico Marani</h1></a>
    <p>Coder, open-source enthusiast, command-line addict. CTO at TalentRank. Former Head of Engineering @TrialReach</p>
    <div id="follow-icons">
        <a href="http://twitter.com/flagZ"><i class="fa fa-twitter-square fa-2x"></i></a>
        <a href="http://uk.linkedin.com/in/federicomarani"><i class="fa fa-linkedin-square fa-2x"></i></a>
        <a href="http://github.com/fmarani"><i class="fa fa-github-square fa-2x"></i></a>
        <a href="mailto:flagzeta@gmail.com"><i class="fa fa-envelope-square fa-2x"></i></a>
        <a href=""><i class="fa fa-rss-square fa-2x"></i></a> 
    </div>                                                                  
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
        <h6><a href="http://flagzeta.org/about/">About me</a></h6>
        
    
        
        <h6><a href="http://flagzeta.org/projects/">Side Projects</a></h6>
        
    
</header>


<article>
    <div class="post-stamp">
        2 Apr 2009
        <span class="taglist">&middot;
            laconica pubsub 
        </span>
    </div>
	<h1 class="post-title">Tag-based routing in laconi.ca</h1>
        <div class="blogpost-old" style="display: none">
            This post is quite old... Technologies and techniques described here might not apply anymore.
        </div>
	

<p>Following the last article, i have been experimenting again on laconica and pubsub, this time on the idea of &ldquo;<a href="http://metajack.im/2009/01/22/filtering-the-real-time-web/" target="_blank">filtering the real time web</a>&rdquo;.</p>

<p>Stomp and generally JMS messages offer the ability to specify headers and body of the message to transmit, in a way that resembles http requests.
In fact, Stomp protocol is really similar to Http protocol, at least in the general structure. The difference is that there are different methods instead of GET, POST, etc..
<blockquote>HTTP:
<code>
POST /item HTTP/1.0
Header: value</code></p>

<p>POSTBODY</blockquote>
<blockquote>STOMP (after CONNECT command)
<code>
SEND
destination: /item</code></p>

<p>MESSAGE_BODY</blockquote>
Very readable, like HTTP. However the main difference is that Stomp, like XMPP, is a stateful and bidirectional protocol.</p>

<p>Like XMPP/pubsub, with STOMP and AMQP you can subscribe to a topic (a.k.a. pubsub node). However content-based routing is only done by STOMP and AMQP (in a way specified by the standard).
AMQP is still in its early days. STOMP is a ready-to-use protocol as many of its implementations.</p>

<p>In the Stomp SUBSCRIBE operation it is possible to specify a JMS Selector. It&rsquo;s a header passed when subscribing and it contains a SQL-92 Statement. SQL attributes to match the conditions against are the other headers.</p>

<h2 id="filtering-laconica-public-timeline-by-tags">FILTERING LACONICA PUBLIC TIMELINE BY TAGS</h2>

<p>Before filtering, the code of the previous post used to push notices needs to be enriched a bit. Particularly, tags present in the notices are now put in a separate header.
Doing this allows to be the target of a Selector.</p>

<p>Push an additional header:</p>

<pre><code class="language-php">//send tags as headers, so they can be used as JMS selectors
common_log(LOG_DEBUG, 'searching for tags ' . $notice-&gt;id);
$tags = array();
$tag = new Notice_tag();
$tag-&gt;notice_id = $notice-&gt;id;
if ($tag-&gt;find()) {
while ($tag-&gt;fetch()) {
common_log(LOG_DEBUG, 'tag found = ' . $tag-&gt;tag);
array_push($tags,$tag-&gt;tag);
}
}
$tag-&gt;free();

$con-&gt;send('/topic/laconica.allusers',
$notice-&gt;content,
array(
'profile_id' =&gt; $notice-&gt;profile_id,
'tags' =&gt; implode($tags,' ')
)
);
common_log(LOG_DEBUG, 'sent to catch-all topic ' . $notice-&gt;id);

</code></pre>

<p>The Stomp client is really similar to the one of the previous post, but it specifies the additional header &ldquo;selector&rdquo; passed when subscribing.</p>

<p>The selector here is &ldquo;tags LIKE %dent%&rdquo;. This matches all the posts that contains the tag #dent. Substitute it to match the tag you want&hellip;</p>

<pre><code class="language-php">
&lt;?php

require_once &quot;Stomp.php&quot;;

$con = new Stomp('tcp://localhost:61613');
if (!$con-&gt;connect())
    print 'conn failed';

$what = '/topic/laconica.allusers';

$query = 'tags LIKE \'%dent%\'';

if (!$con-&gt;subscribe($what,array(&quot;selector&quot; =&gt; $query)))
    print &quot;sub failed&quot;;
else
    print &quot;sub to &quot;.$what.&quot; successful\n&quot;;

while (true) {
    $msg = $con-&gt;readFrame();
    if ($msg) {
        print $msg-&gt;headers['profile_id'].&quot;: &quot;.$msg-&gt;body. &quot; -- &quot;;
        print &quot;msg_time:&quot;.$msg-&gt;headers['created'].&quot; &quot;;
        print &quot;tags: &quot;.$msg-&gt;headers['tags'].&quot;\n&quot;;
        $con-&gt;ack($msg);
    }
}

$con-&gt;disconnect();
?

</code></pre>

     <div id="disqus_thread"></div>
    <script type="text/javascript">
         
        var disqus_shortname = 'flagzeta'; 

         
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>  
<script type="text/javascript" charset="utf-8">
var cutoffTime = new Date().getTime() - (2 * 365 * 24 * 60 * 60 * 1000);
var postTime = new Date("2009-04-02T23:15:09Z").getTime();
if (postTime < cutoffTime) {
    $(".blogpost-old").show();
}
</script>

		<footer id="footer">
<section id="footer-message">&copy; 2016 Federico Marani. All rights reserved. <a href="https://github.com/kathyqian/crisp-ghost-theme" target="_blank">Crisp</a> theme by <a href="http://kathyqian.com" target="_blank">Kathy Qian</a>.</section>
		</footer>
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47493827-1', 'flagzeta.org');
  ga('send', 'pageview');

</script>
</body>
</html>

